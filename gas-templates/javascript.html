<script>
  // ì „ì—­ ë³€ìˆ˜
  let selectedEmotion = null;
  let selectedSubEmotion = null;
  let currentDiary = null;

  // ì„¸ë¶€ ê°ì • ë§¤í•‘
  const subEmotions = {
    'ë§‘ìŒ': ['ê¸°ì¨', 'ì¦ê±°ì›€', 'ì‹ ë‚¨', 'í–‰ë³µí•¨', 'ë§Œì¡±í•¨'],
    'êµ¬ë¦„ì¡°ê¸ˆ': ['í‰ë²”í•¨', 'ê´œì°®ìŒ', 'ë³´í†µ', 'ê·¸ì €ê·¸ëŸ¼'],
    'íë¦¼': ['ìš°ìš¸í•¨', 'ì‹¬ì‹¬í•¨', 'ì§€ë£¨í•¨', 'í”¼ê³¤í•¨'],
    'ë¹„': ['ìŠ¬í””', 'ì™¸ë¡œì›€', 'ì„œìš´í•¨', 'ê·¸ë¦¬ì›€'],
    'ë²ˆê°œ': ['í™”ë‚¨', 'ì§œì¦ë‚¨', 'ë‹µë‹µí•¨', 'ì–µìš¸í•¨'],
    'ë¬´ì§€ê°œ': ['íŠ¹ë³„í•¨', 'ê°ë™', 'ë¿Œë“¯í•¨', 'ì„¤ë ˜'],
    'ì•ˆê°œ': ['í˜¼ë€ìŠ¤ëŸ¬ì›€', 'ëª¨ë¥´ê² ìŒ', 'ë³µì¡í•¨', 'ì–´ë ¤ì›€']
  };

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', function() {
    // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('diaryDate').value = today;

    // ì €ì¥ëœ í•™ìƒ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    loadStudentInfo();

    // ê°ì • ë‚ ì”¨ ì„ íƒ ì´ë²¤íŠ¸ ë“±ë¡
    document.querySelectorAll('.emotion-item').forEach(item => {
      item.addEventListener('click', function() {
        selectEmotion(this);
      });
    });

    // í•™ë°˜ ì…ë ¥ ë„ì›€ë§ ì´ë²¤íŠ¸
    setupClassInputHelp();

    // í˜ì´ì§€ íŒŒë¼ë¯¸í„° ì²˜ë¦¬
    handlePageParams();

    // ìë™ ì €ì¥ (5ë¶„ë§ˆë‹¤)
    setInterval(autoSave, 300000);

    // ìë™ ì €ì¥ ë³µì› í™•ì¸ (ìƒˆë¡œ ì‘ì„±í•˜ê¸° ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ)
    if (!pageParams.newDiary) {
      setTimeout(restoreAutoSave, 1000);
    }
  });

  // í•™ë°˜ ì…ë ¥ ë„ì›€ë§ ì„¤ì •
  function setupClassInputHelp() {
    const classInput = document.getElementById('studentClass');
    
    // í¬ì»¤ìŠ¤ ì‹œ ì˜ˆì‹œ í‘œì‹œ
    classInput.addEventListener('focus', function() {
      showInfoMessage('ğŸ’¡ í•™ë°˜ì€ ì—¬ëŸ¬ í˜•íƒœë¡œ ì…ë ¥ ê°€ëŠ¥í•´ìš”: 3-1, 3í•™ë…„ 1ë°˜, 3-1-15 ë“±');
    });

    // ì…ë ¥ ì¤‘ ì‹¤ì‹œê°„ ê²€ì¦
    classInput.addEventListener('input', function() {
      const value = this.value.trim();
      if (value) {
        const converted = previewClassConversion(value);
        if (converted && converted !== value) {
          showTooltip(this, `â†’ ${converted}ë¡œ ì¸ì‹ë©ë‹ˆë‹¤`);
        }
      }
    });
  }

  // í•™ë°˜ ë³€í™˜ ë¯¸ë¦¬ë³´ê¸° (í´ë¼ì´ì–¸íŠ¸ìš©)
  function previewClassConversion(input) {
    if (!input) return '';
    
    const trimmed = String(input).trim();
    
    // ì´ë¯¸ í‘œì¤€ í˜•íƒœ
    if (/^\d+-\d+$/.test(trimmed)) {
      return trimmed;
    }
    
    // í•™ë²ˆ í˜•íƒœ
    if (/^\d+-\d+-\d+$/.test(trimmed)) {
      const parts = trimmed.split('-');
      return `${parts[0]}-${parts[1]}`;
    }
    
    // í•œê¸€ í˜•íƒœ
    const koreanMatch = trimmed.match(/(\d+).*?(\d+)/);
    if (koreanMatch) {
      return `${koreanMatch[1]}-${koreanMatch[2]}`;
    }
    
    // ê³µë°± êµ¬ë¶„
    const spaceMatch = trimmed.match(/^(\d+)\s+(\d+)$/);
    if (spaceMatch) {
      return `${spaceMatch[1]}-${spaceMatch[2]}`;
    }
    
    return null;
  }

  // íˆ´íŒ í‘œì‹œ
  function showTooltip(element, message) {
    // ê¸°ì¡´ íˆ´íŒ ì œê±°
    const existingTooltip = document.querySelector('.input-tooltip');
    if (existingTooltip) {
      existingTooltip.remove();
    }

    const tooltip = document.createElement('div');
    tooltip.className = 'input-tooltip';
    tooltip.textContent = message;
    tooltip.style.cssText = `
      position: absolute;
      background: #48bb78;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.8em;
      top: ${element.offsetTop + element.offsetHeight + 5}px;
      left: ${element.offsetLeft}px;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    `;

    element.parentNode.appendChild(tooltip);

    // 3ì´ˆ í›„ ì œê±°
    setTimeout(() => {
      if (tooltip.parentNode) {
        tooltip.parentNode.removeChild(tooltip);
      }
    }, 3000);
  }

  // í˜ì´ì§€ íŒŒë¼ë¯¸í„° ì²˜ë¦¬
  function handlePageParams() {
    if (typeof pageParams !== 'undefined') {
      if (pageParams.newDiary) {
        clearFormOnly();
        showSuccessMessage('ìƒˆë¡œìš´ ì¼ê¸°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤! âœ¨');
      } else if (pageParams.viewMyDiaries) {
        setTimeout(() => {
          const name = document.getElementById('studentName').value;
          const studentClass = document.getElementById('studentClass').value;
          
          if (name && studentClass) {
            loadMyDiaries();
          } else {
            showInfoMessage('ì´ë¦„ê³¼ í•™ë°˜ì„ ì…ë ¥í•˜ê³  "ë‚´ ì¼ê¸° ë³´ê¸°"ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”! ğŸ“š');
          }
        }, 1000);
      }
    }
  }

  // í•™ìƒ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadStudentInfo() {
    const savedName = localStorage.getItem('studentName');
    const savedClass = localStorage.getItem('studentClass');

    if (savedName) document.getElementById('studentName').value = savedName;
    if (savedClass) document.getElementById('studentClass').value = savedClass;
  }

  // í•™ìƒ ì •ë³´ ì €ì¥
  function saveStudentInfo() {
    const name = document.getElementById('studentName').value;
    const studentClass = document.getElementById('studentClass').value;

    localStorage.setItem('studentName', name);
    localStorage.setItem('studentClass', studentClass);
  }

  // ê°ì • ì„ íƒ
  function selectEmotion(element) {
    document.querySelectorAll('.emotion-item').forEach(item => {
      item.classList.remove('selected');
    });

    element.classList.add('selected');
    selectedEmotion = element.dataset.emotion;

    // ì„ íƒ íš¨ê³¼ ì• ë‹ˆë©”ì´ì…˜
    element.style.transform = 'scale(1.1)';
    setTimeout(() => {
      element.style.transform = '';
    }, 200);

    showSubEmotions(selectedEmotion);
  }

  // ì„¸ë¶€ ê°ì • í‘œì‹œ
  function showSubEmotions(emotion) {
    const subEmotionCard = document.getElementById('subEmotionCard');
    const container = document.getElementById('subEmotionContainer');

    container.innerHTML = '';
    selectedSubEmotion = null;

    if (subEmotions[emotion]) {
      subEmotionCard.style.display = 'block';

      subEmotions[emotion].forEach((subEmotion, index) => {
        setTimeout(() => {
          const item = document.createElement('div');
          item.className = 'sub-emotion-item';
          item.textContent = subEmotion;
          item.style.animation = 'slideIn 0.3s ease-out';
          item.onclick = function() {
            selectSubEmotion(this, subEmotion);
          };
          container.appendChild(item);
        }, index * 50);
      });
    }
  }

  // ì„¸ë¶€ ê°ì • ì„ íƒ
  function selectSubEmotion(element, emotion) {
    document.querySelectorAll('.sub-emotion-item').forEach(item => {
      item.classList.remove('selected');
    });

    element.classList.add('selected');
    selectedSubEmotion = emotion;
  }

  // ì¼ê¸° ì €ì¥
  function saveDiary() {
    if (!validateForm()) return;

    showLoading();
    saveStudentInfo();

    const diaryData = {
      name: document.getElementById('studentName').value.trim(),
      studentClass: document.getElementById('studentClass').value.trim(),
      date: document.getElementById('diaryDate').value,
      emotion: selectedEmotion,
      subEmotion: selectedSubEmotion,
      content: document.getElementById('diaryContent').value
    };

    google.script.run
      .withSuccessHandler(function(result) {
        hideLoading();
        if (result.success) {
          showSuccessMessage(result.message);
          currentDiary = diaryData;
          localStorage.removeItem('autoSave');
        } else {
          showErrorMessage(result.message);
        }
      })
      .withFailureHandler(function(error) {
        hideLoading();
        showErrorMessage('ì €ì¥ ì˜¤ë¥˜: ' + error);
      })
      .saveDiary(diaryData);
  }

  // ì„ ìƒë‹˜ê»˜ ì „ì†¡
  function sendToTeacher() {
    if (!currentDiary && !validateForm()) return;

    if (!confirm('ì„ ìƒë‹˜ê»˜ ì¼ê¸°ë¥¼ ë³´ë‚¼ê¹Œìš”?')) return;

    showLoading();

    const diaryData = currentDiary || {
      name: document.getElementById('studentName').value.trim(),
      studentClass: document.getElementById('studentClass').value.trim(),
      date: document.getElementById('diaryDate').value,
      emotion: selectedEmotion,
      subEmotion: selectedSubEmotion,
      content: document.getElementById('diaryContent').value
    };

    google.script.run
      .withSuccessHandler(function(result) {
        hideLoading();
        if (result.success) {
          showSuccessMessage(result.message);
        } else {
          showErrorMessage(result.message);
        }
      })
      .withFailureHandler(function(error) {
        hideLoading();
        showErrorMessage('ì „ì†¡ ì˜¤ë¥˜: ' + error);
      })
      .sendToTeacher(diaryData);
  }

  // ë‚´ ì¼ê¸° ë¶ˆëŸ¬ì˜¤ê¸° (ê°œì„ ëœ ë²„ì „)
  function loadMyDiaries() {
    const name = document.getElementById('studentName').value.trim();
    const studentClass = document.getElementById('studentClass').value.trim();

    console.log('loadMyDiaries í˜¸ì¶œ:', name, studentClass);

    if (!name || !studentClass) {
      showErrorMessage('ì´ë¦„ê³¼ í•™ë°˜ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
      return;
    }

    // í•™ë°˜ í˜•ì‹ ë¯¸ë¦¬ ê²€ì¦
    const convertedClass = previewClassConversion(studentClass);
    if (convertedClass && convertedClass !== studentClass) {
      showInfoMessage(`í•™ë°˜ì„ "${convertedClass}"ë¡œ ì¸ì‹í•˜ì—¬ ê²€ìƒ‰í•©ë‹ˆë‹¤ ğŸ”`);
    }

    showLoading();
    saveStudentInfo();

    google.script.run
      .withSuccessHandler(function(result) {
        console.log('ì„œë²„ ì‘ë‹µ:', result);
        hideLoading();
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            displayMyDiaries(result.data);
            document.getElementById('myDiariesCard').style.display = 'block';
            showSuccessMessage(`${result.data.length}ê°œì˜ ì¼ê¸°ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤! ğŸ“š`);
          } else {
            document.getElementById('myDiariesCard').style.display = 'block';
            displayMyDiaries([]);
            showInfoMessage('ì•„ì§ ì‘ì„±í•œ ì¼ê¸°ê°€ ì—†ì–´ìš”. ì²« ë²ˆì§¸ ì¼ê¸°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”! âœ¨');
          }
        } else {
          showErrorMessage(result.message || 'ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      })
      .withFailureHandler(function(error) {
        console.error('í´ë¼ì´ì–¸íŠ¸ ì˜¤ë¥˜:', error);
        hideLoading();
        showErrorMessage('ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ' + error.toString());
      })
      .getMyDiaries(name, studentClass);
  }

  // ì¼ê¸° ëª©ë¡ í‘œì‹œ (í–¥ìƒëœ ë””ìì¸)
  function displayMyDiaries(diaries) {
    const container = document.getElementById('myDiariesContainer');
    container.innerHTML = '';

    if (diaries.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #999;">
          <div style="font-size: 4em; margin-bottom: 20px;">ğŸ“</div>
          <h3>ì•„ì§ ì‘ì„±í•œ ì¼ê¸°ê°€ ì—†ì–´ìš”!</h3>
          <p style="margin-top: 10px;">ì²« ë²ˆì§¸ ë§ˆìŒë‚ ì”¨ ì¼ê¸°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”.</p>
        </div>
      `;
      return;
    }

    const emotionEmojis = {
      'ë§‘ìŒ': 'â˜€ï¸', 'êµ¬ë¦„ì¡°ê¸ˆ': 'â›…', 'íë¦¼': 'â˜ï¸', 'ë¹„': 'ğŸŒ§ï¸',
      'ë²ˆê°œ': 'âš¡', 'ë¬´ì§€ê°œ': 'ğŸŒˆ', 'ì•ˆê°œ': 'ğŸŒ«ï¸'
    };

    // í—¤ë” ì¶”ê°€
    const headerDiv = document.createElement('div');
    headerDiv.style.cssText = 'text-align: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;';
    headerDiv.innerHTML = `<strong>ğŸ“š ì´ ${diaries.length}ê°œì˜ ì¼ê¸°</strong>`;
    container.appendChild(headerDiv);

    diaries.forEach((diary, index) => {
      setTimeout(() => {
        const diaryItem = document.createElement('div');
        diaryItem.className = 'diary-item';
        diaryItem.style.cssText = `
          background: white;
          border: 1px solid #e2e8f0;
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 15px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          transition: all 0.3s ease;
          animation: slideInUp 0.5s ease-out;
          cursor: pointer;
        `;

        const diaryDate = diary.date;
        const formatDate = new Date(diaryDate).toLocaleDateString('ko-KR', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          weekday: 'short'
        });

        diaryItem.innerHTML = `
          <div class="diary-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 2em;">${emotionEmojis[diary.emotion] || 'â“'}</span>
              <div>
                <div style="font-weight: bold; color: #2d3748;">${formatDate}</div>
                <div style="font-size: 0.9em; color: #666;">${diary.emotion}${diary.subEmotion ? ` - ${diary.subEmotion}` : ''}</div>
              </div>
            </div>
            <div style="text-align: right;">
              ${diary.status === 'ì „ì†¡ì™„ë£Œ' ? 
                '<span style="background: #48bb78; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8em;">âœ“ ì „ì†¡ì™„ë£Œ</span>' : 
                '<span style="background: #ed8936; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8em;">ğŸ“ ì €ì¥ë¨</span>'
              }
            </div>
          </div>
          <div class="diary-content" style="
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            line-height: 1.6;
            color: #2d3748;
            white-space: pre-wrap;
          ">${diary.content}</div>
        `;

        // í˜¸ë²„ íš¨ê³¼
        diaryItem.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-2px)';
          this.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';
        });

        diaryItem.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
        });

        container.appendChild(diaryItem);
      }, index * 100);
    });
  }

  // í¼ ìœ íš¨ì„± ê²€ì‚¬ (ê°œì„ )
  function validateForm() {
    const name = document.getElementById('studentName').value.trim();
    const studentClass = document.getElementById('studentClass').value.trim();
    const content = document.getElementById('diaryContent').value.trim();

    if (!name || !studentClass) {
      showErrorMessage('ì´ë¦„ê³¼ í•™ë°˜ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
      return false;
    }

    // í•™ë°˜ í˜•ì‹ ê²€ì¦
    const convertedClass = previewClassConversion(studentClass);
    if (!convertedClass) {
      showErrorMessage('í•™ë°˜ í˜•ì‹ì„ ì¸ì‹í•  ìˆ˜ ì—†ì–´ìš”. ì˜ˆ: 3-1, 3í•™ë…„ 1ë°˜, 3-1-15');
      return false;
    }

    if (!selectedEmotion) {
      showErrorMessage('ì˜¤ëŠ˜ì˜ ë§ˆìŒ ë‚ ì”¨ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
      return false;
    }

    if (!content) {
      showErrorMessage('ì¼ê¸° ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”!');
      return false;
    }

    return true;
  }

  // ì‘ì„± ë„ì›€ë§ í‘œì‹œ
  function showWritingTips() {
    document.getElementById('writingTipsModal').style.display = 'block';
  }

  // ì‘ì„± ë„ì›€ë§ ë‹«ê¸°
  function closeWritingTips() {
    document.getElementById('writingTipsModal').style.display = 'none';
  }

  // ìë™ ì €ì¥
  function autoSave() {
    const content = document.getElementById('diaryContent').value;
    if (content && selectedEmotion) {
      localStorage.setItem('autoSave', JSON.stringify({
        emotion: selectedEmotion,
        subEmotion: selectedSubEmotion,
        content: content,
        date: document.getElementById('diaryDate').value
      }));
    }
  }

  // ìë™ ì €ì¥ ë³µì›
  function restoreAutoSave() {
    const saved = localStorage.getItem('autoSave');
    if (saved) {
      const data = JSON.parse(saved);
      if (confirm('ìë™ ì €ì¥ëœ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        document.getElementById('diaryDate').value = data.date;
        document.getElementById('diaryContent').value = data.content;
        const emotionElement = document.querySelector(`[data-emotion="${data.emotion}"]`);
        if (emotionElement) {
          emotionElement.click();
          if (data.subEmotion) {
            setTimeout(() => {
              const subEmotionElements = document.querySelectorAll('.sub-emotion-item');
              subEmotionElements.forEach(item => {
                if (item.textContent === data.subEmotion) {
                  item.click();
                }
              });
            }, 500);
          }
        }
      }
    }
  }

  // ìŒì„± ì…ë ¥
  function startVoiceInput() {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
      showErrorMessage('ìŒì„± ì…ë ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
      return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();

    recognition.lang = 'ko-KR';
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = function() {
      showInfoMessage('ë§ì”€í•´ì£¼ì„¸ìš”... ğŸ¤');
    };

    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      const textarea = document.getElementById('diaryContent');
      const cursorPos = textarea.selectionStart;
      const textBefore = textarea.value.substring(0, cursorPos);
      const textAfter = textarea.value.substring(cursorPos);
      
      textarea.value = textBefore + ' ' + transcript + textAfter;
      showSuccessMessage('ìŒì„±ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨');
    };

    recognition.onerror = function(event) {
      showErrorMessage('ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ' + event.error);
    };

    recognition.start();
  }

  // ì´ëª¨ì§€ ì‚½ì…
  function insertEmoji() {
    const emojis = [
      'ğŸ˜Š', 'ğŸ˜„', 'ğŸ˜ƒ', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜',
      'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜±', 'ğŸ˜´',
      'ğŸ¤”', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ™„', 'ğŸ˜', 'ğŸ˜£', 'ğŸ˜¥', 'ğŸ˜®',
      'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”',
      'ğŸ‘', 'ğŸ‘', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ¤—', 'ğŸ¤', 'ğŸ™', 'âœ¨', 'â­', 'ğŸŒŸ'
    ];

    const popup = document.createElement('div');
    popup.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 2000;
      max-width: 350px;
      max-height: 400px;
      overflow-y: auto;
    `;

    const header = document.createElement('div');
    header.innerHTML = '<h3 style="margin-top: 0;">ğŸ˜Š ì´ëª¨ì§€ ì„ íƒ</h3>';
    popup.appendChild(header);

    const grid = document.createElement('div');
    grid.style.cssText = 'display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;';

    emojis.forEach(emoji => {
      const btn = document.createElement('button');
      btn.textContent = emoji;
      btn.style.cssText = `
        font-size: 24px; 
        padding: 8px; 
        border: 1px solid #ddd; 
        background: #f9f9f9; 
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.2s ease;
      `;
      
      btn.onmouseover = function() {
        this.style.background = '#e3f2fd';
        this.style.transform = 'scale(1.1)';
      };
      
      btn.onmouseout = function() {
        this.style.background = '#f9f9f9';
        this.style.transform = 'scale(1)';
      };
      
      btn.onclick = function() {
        const textarea = document.getElementById('diaryContent');
        const cursorPos = textarea.selectionStart;
        const textBefore = textarea.value.substring(0, cursorPos);
        const textAfter = textarea.value.substring(cursorPos);

        textarea.value = textBefore + emoji + textAfter;
        textarea.focus();
        textarea.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);

        document.body.removeChild(popup);
        showSuccessMessage('ì´ëª¨ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ' + emoji);
      };
      grid.appendChild(btn);
    });

    popup.appendChild(grid);
    document.body.appendChild(popup);

    // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    setTimeout(() => {
      document.addEventListener('click', function closePopup(e) {
        if (!popup.contains(e.target)) {
          if (popup.parentNode) {
            document.body.removeChild(popup);
          }
          document.removeEventListener('click', closePopup);
        }
      });
    }, 100);
  }

  // ì´ë¯¸ì§€ë¡œ ì €ì¥
  function saveAsImage() {
    if (!currentDiary && !validateForm()) return;

    const diaryData = currentDiary || {
      name: document.getElementById('studentName').value.trim(),
      studentClass: document.getElementById('studentClass').value.trim(),
      date: document.getElementById('diaryDate').value,
      emotion: selectedEmotion,
      subEmotion: selectedSubEmotion,
      content: document.getElementById('diaryContent').value
    };

    createDiaryImage(diaryData);
  }

  // ì¼ê¸° ì´ë¯¸ì§€ ìƒì„±
  function createDiaryImage(diaryData) {
    const canvas = document.getElementById('diaryCanvas');
    const ctx = canvas.getContext('2d');

    canvas.width = 800;
    canvas.height = 600;

    // ë°°ê²½
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // ê·¸ë¼ë°ì´ì…˜ í—¤ë”
    const gradient = ctx.createLinearGradient(0, 0, canvas.width, 150);
    gradient.addColorStop(0, '#667eea');
    gradient.addColorStop(1, '#764ba2');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, 150);

    // ì œëª©
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 36px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸŒˆ ë§ˆìŒë‚ ì”¨ ì¼ê¸°', canvas.width / 2, 60);

    // ë‚ ì§œ
    ctx.font = '24px sans-serif';
    ctx.fillText(diaryData.date, canvas.width / 2, 100);

    // ê°ì • ì´ëª¨ì§€
    const emotionEmojis = {
      'ë§‘ìŒ': 'â˜€ï¸', 'êµ¬ë¦„ì¡°ê¸ˆ': 'â›…', 'íë¦¼': 'â˜ï¸', 'ë¹„': 'ğŸŒ§ï¸',
      'ë²ˆê°œ': 'âš¡', 'ë¬´ì§€ê°œ': 'ğŸŒˆ', 'ì•ˆê°œ': 'ğŸŒ«ï¸'
    };

    ctx.font = '80px sans-serif';
    ctx.fillText(emotionEmojis[diaryData.emotion] || 'â“', canvas.width / 2, 220);

    // ê°ì • í…ìŠ¤íŠ¸
    ctx.fillStyle = '#333333';
    ctx.font = 'bold 28px sans-serif';
    ctx.fillText(diaryData.emotion + (diaryData.subEmotion ? ' - ' + diaryData.subEmotion : ''), canvas.width / 2, 280);

    // ì¼ê¸° ë‚´ìš© ë°•ìŠ¤
    ctx.fillStyle = '#f7fafc';
    ctx.fillRect(50, 320, canvas.width - 100, 200);

    // ì¼ê¸° ë‚´ìš©
    ctx.fillStyle = '#2d3748';
    ctx.font = '20px sans-serif';
    ctx.textAlign = 'left';

    const lines = wrapText(ctx, diaryData.content, canvas.width - 140);
    let y = 360;
    lines.forEach(line => {
      ctx.fillText(line, 70, y);
      y += 30;
    });

    // ì„œëª…
    ctx.fillStyle = '#999999';
    ctx.font = '16px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(diaryData.name + 'ì˜ ë§ˆìŒë‚ ì”¨ ì¼ê¸°', canvas.width / 2, canvas.height - 30);

    // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
    canvas.toBlob(function(blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ë§ˆìŒë‚ ì”¨ì¼ê¸°_${diaryData.date}_${diaryData.name}.png`;
      a.click();
      URL.revokeObjectURL(url);
      showSuccessMessage('ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¸');
    });
  }

  // í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ í•¨ìˆ˜
  function wrapText(ctx, text, maxWidth) {
    const words = text.split('');
    const lines = [];
    let currentLine = '';

    for (let i = 0; i < words.length; i++) {
      const testLine = currentLine + words[i];
      const metrics = ctx.measureText(testLine);
      const testWidth = metrics.width;

      if (testWidth > maxWidth && i > 0) {
        lines.push(currentLine);
        currentLine = words[i];
      } else {
        currentLine = testLine;
      }
    }

    lines.push(currentLine);
    return lines.slice(0, 5);
  }

  // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
  function refreshPage() {
    const choice = confirm('ìƒˆë¡œê³ ì¹¨ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”:\n\ní™•ì¸ = ì „ì²´ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨\nì·¨ì†Œ = í¼ë§Œ ì´ˆê¸°í™”');
    
    if (choice) {
      location.reload();
    } else {
      clearFormOnly();
    }
  }

  // í¼ë§Œ ì´ˆê¸°í™”
  function clearFormOnly() {
    selectedEmotion = null;
    selectedSubEmotion = null;
    currentDiary = null;
    
    document.getElementById('diaryContent').value = '';
    document.querySelectorAll('.emotion-item').forEach(item => {
      item.classList.remove('selected');
    });
    document.getElementById('subEmotionCard').style.display = 'none';
    document.getElementById('myDiariesCard').style.display = 'none';
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('diaryDate').value = today;
    
    localStorage.removeItem('autoSave');
    showSuccessMessage('í¼ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨');
  }

  // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ë“¤
  function showSuccessMessage(message) {
    showMessage(message, 'success');
  }

  function showErrorMessage(message) {
    showMessage(message, 'error');
  }

  function showInfoMessage(message) {
    showMessage(message, 'info');
  }

  function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      z-index: 3000;
      animation: slideIn 0.3s ease-out;
      max-width: 300px;
      word-wrap: break-word;
    `;

    const colors = {
      success: '#48bb78',
      error: '#e53e3e',
      info: '#4299e1'
    };

    messageDiv.style.background = colors[type] || colors.info;
    messageDiv.textContent = message;

    document.body.appendChild(messageDiv);

    setTimeout(() => {
      messageDiv.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => {
        if (messageDiv.parentNode) {
          document.body.removeChild(messageDiv);
        }
      }, 300);
    }, 4000);
  }

  // ë¡œë”© í‘œì‹œ/ìˆ¨ê¸°ê¸°
  function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
  }

  // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal {
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 0;
      border-radius: 15px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px 15px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 20px;
    }

    .close {
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      opacity: 0.7;
    }

    .close:hover {
      opacity: 1;
    }

    .tip-section {
      margin-bottom: 20px;
    }

    .tip-section h4 {
      margin-bottom: 10px;
      color: #2d3748;
    }

    .tip-section ul {
      padding-left: 20px;
    }

    .tip-section li {
      margin-bottom: 5px;
      line-height: 1.5;
    }

    .emotion-tips {
      display: grid;
      gap: 8px;
    }

    .tip-item {
      padding: 8px;
      background: #f7fafc;
      border-radius: 8px;
      font-size: 0.9em;
    }

    .input-help {
      color: #666;
      font-size: 0.8em;
      margin-top: 5px;
      display: block;
    }
  `;
  document.head.appendChild(style);
</script>